#==========================================================================================================================================================================================================================================#
#	CONFIGURATION :
#==========================================================================================================================================================================================================================================#
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	SOFTWARE PATHS
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
if [[ -z "${SEQUEL_SAMTOOLS:+x}" ]] ; then SEQUEL_SAMTOOLS="samtools" ; fi
if ! [ -x "$(command -v $SEQUEL_SAMTOOLS)" ]; then echo -e "\n${SCRIPT_Name}]:\tNo samtools detected; add to PATH or set SEQUEL_SAMTOOLS\n" ; exit 1 ; fi

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	PIPELINE PATHS
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
SEQUEL_STATS_path="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

SEQUEL_extract="${SEQUEL_STATS_path}/SEQUEL_extract.awk"
SEQUEL_preprocess="${SEQUEL_STATS_path}/SEQUEL_preprocess.awk"
SEQUEL_process="${SEQUEL_STATS_path}/SEQUEL_process.awk"
SEQUEL_stats="${SEQUEL_STATS_path}/SEQUEL_stats.pl"

declare -A SPIPE_STEP

SPIPE_STEP["STEP_01"]="${SEQUEL_STATS_path}/SEQUEL_STEP_01.sh"
SPIPE_STEP["STEP_02"]="${SEQUEL_STATS_path}/SEQUEL_STEP_02.sh"
SPIPE_STEP["STEP_03"]="${SEQUEL_STATS_path}/SEQUEL_STEP_03.sh"
SPIPE_STEP["STEP_04"]="${SEQUEL_STATS_path}/SEQUEL_STEP_04.sh"

#==========================================================================================================================================================================================================================================#



#==========================================================================================================================================================================================================================================#
#	COMMAND-LINE PARAMETER
#==========================================================================================================================================================================================================================================#

SCRIPT_Name="$(basename $0)"

if [[ -z "${1:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNo \"subreads\" BAM FOFN specified!\n"     ; exit 1 ; fi
if [[ -z "${2:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNo \"scraps\" BAM FOFN specified!\n"       ; exit 2 ; fi
if [[ -z "${3:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNo output directory specified!\n"          ; exit 3 ; fi
if [[ -z "${4:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNo SMRTcell (i.e. line index) selected!\n" ; exit 4 ; fi
if [[ -z "${5:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNo step name for given run specified!\n"   ; exit 5 ; fi

SPIPE_srfofn="${1}"	# "Subreads" BAM FOFN
SPIPE_scfofn="${2}"	# "Scraps"   BAM FOFN
SPIPE_dpath="${3}"	# Output path
SPIPE_smrtci="${4}"	# Line index for SMRTcell entry in both FOFNs
SPIPE_step="${5}"	# Step name e.g. "STEP_01"


SPIPE_dpath=`echo "${SPIPE_dpath}" | sed -r 's/\/+$//'`

if ! [[ -e "${SPIPE_srfofn}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"subreads\" BAM FOFN does not exist!\n" ; exit 6 ; fi
if ! [[ -e "${SPIPE_scfofn}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"scraps\" BAM FOFN does not exist!\n"   ; exit 7 ; fi

#==========================================================================================================================================================================================================================================#



#==========================================================================================================================================================================================================================================#
#	PIPELINE PREPARATION
#==========================================================================================================================================================================================================================================#
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	INITIALISE VARIABLES
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
SPIPE_srfs=`cat "${SPIPE_srfofn}" | wc -l`	# Count number of files in "subread" FOFN
SPIPE_scfs=`cat "${SPIPE_scfofn}" | wc -l`	# Count number of files in "scraps"  FOFN

if [[ "${SPIPE_srfs}" -ne "${SPIPE_scfs}"   ]] ; then echo -e "\n[${SCRIPT_Name}]:\tNumber of \"subreads\" and \"scraps\" files does not match!\n" ; exit 8 ; fi
if [[ "${SPIPE_srfs}" -lt "${SPIPE_smrtci}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tSMRTcell index larger than number of files in FOFNs!\n"        ; exit 9 ; fi

SPIPE_srbam=`cat "${SPIPE_srfofn}" | head -n "${SPIPE_smrtci}" | tail -n 1`			# Select "subreads" BAM
SPIPE_scbam=`cat "${SPIPE_scfofn}" | head -n "${SPIPE_smrtci}" | tail -n 1`			# Select "scraps"   BAM
SPIPE_srsmrtc=`echo "${SPIPE_srbam}" | sed -r 's/^.{0,}\/(.+)\.subreads\.bam$/\1/'`	# Extract SMRTcell ID for "subreads" BAM
SPIPE_scsmrtc=`echo "${SPIPE_scbam}" | sed -r 's/^.{0,}\/(.+)\.scraps\.bam$/\1/'`	# Extract SMRTcell ID for "scraps"   BAM

if [[ "${SPIPE_srsmrtc}" -ne "${SPIPE_scsmrtc}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\tSMRTcell IDs for \"subreads\" (${SPIPE_srsmrtc}) and \"scraps\" (${SPIPE_scsmrtc}) BAM file do not match!\n" ; exit 10 ; fi

SPIPE_smrtc="${SPIPE_srsmrtc}"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	GENERATE PIPELINE FOLDER STRUCTURE FOR SMRTcell
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
SPIPE_out="${SPIPE_dpath}/${SPIPE_smrtc}/out"
SPIPE_err="${SPIPE_dpath}/${SPIPE_smrtc}/err"
SPIPE_ext="${SPIPE_dpath}/${SPIPE_smrtc}/extracted"
SPIPE_pre="${SPIPE_dpath}/${SPIPE_smrtc}/preprocessed"
SPIPE_pro="${SPIPE_dpath}/${SPIPE_smrtc}/processed"
SPIPE_sta="${SPIPE_dpath}/${SPIPE_smrtc}/stats"

mkdir -p "${SPIPE_dpath}"

mkdir -p "${SPIPE_out}"
mkdir -p "${SPIPE_err}"
mkdir -p "${SPIPE_ext}"
mkdir -p "${SPIPE_pre}"
mkdir -p "${SPIPE_pro}"
mkdir -p "${SPIPE_sta}"

#==========================================================================================================================================================================================================================================#



#==========================================================================================================================================================================================================================================#
#	RUN PREPARATION :
#==========================================================================================================================================================================================================================================#

export SEQUEL_SAMTOOLS
export SEQUEL_extract
export SEQUEL_preprocess
export SEQUEL_process
export SEQUEL_stats

export SPIPE_dpath
export SPIPE_srbam
export SPIPE_scbam
export SPIPE_smrtc
export SPIPE_step

export SPIPE_out
export SPIPE_err
export SPIPE_ext
export SPIPE_pre
export SPIPE_pro
export SPIPE_sta

#==========================================================================================================================================================================================================================================#



#==========================================================================================================================================================================================================================================#
#	RUN :
#==========================================================================================================================================================================================================================================#

"${SPIPE_STEP[${SPIPE_step}]}"

#==========================================================================================================================================================================================================================================#
