#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	CHECK IMPORTED VARIABLES
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#

SCRIPT_Name="$(basename $0)"

if [[ -z "${SPIPE_dpath:+x}" ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SPIPE_dpath\" not set!\n" ; exit 1 ; fi
if [[ -z "${SPIPE_smrtc+x}"  ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SPIPE_smrtc\" not set!\n" ; exit 2 ; fi
if [[ -z "${SPIPE_ext:+x}"   ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SPIPE_ext\" not set!\n"   ; exit 3 ; fi
if [[ -z "${SPIPE_pre:+x}"   ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SPIPE_pre\" not set!\n"   ; exit 4 ; fi
if [[ -z "${SPIPE_step:+x}"  ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SPIPE_step\" not set!\n"  ; exit 5 ; fi

if [[ -z "${SEQUEL_preprocess:+x}"  ]] ; then echo -e "\n[${SCRIPT_Name}]:\t\"SEQUEL_preprocess\" not set!\n"  ; exit 6 ; fi

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	INITIALISE VARIABLES
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#

SEQL_block="${SPIPE_dpath}/${SPIPE_step}.RUNNING.${SPIPE_smrtc}"	# This file acts as a kind of "road block": while it exists the next step cannot start!

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
#	RUN
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#

echo "Starting '${SPIPE_step}' ..." > "${SEQL_block}"

########################################################################################################################################################################################
# Line-wrapped command :
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#
#	cat
#	"${SPIPE_ext}/EXT.${SPIPE_smrtc}.sc.txt"
#	"${SPIPE_ext}/EXT.${SPIPE_smrtc}.sr.txt"
#	| sort -k2,2n -k3,3n -k4,4n
#	| awk -f "${SEQUEL_preprocess}"
#	> "${SPIPE_pre}/PRE.${SPIPE_smrtc}.txt"
#
########################################################################################################################################################################################

cat "${SPIPE_ext}/EXT.${SPIPE_smrtc}.sc.txt" "${SPIPE_ext}/EXT.${SPIPE_smrtc}.sr.txt" | sort -k2,2n -k3,3n -k4,4n | awk -f "${SEQUEL_preprocess}" > "${SPIPE_pre}/PRE.${SPIPE_smrtc}.txt"


SEQL_status=("${PIPESTATUS[@]}")

if [[ "${SEQL_status[0]}" -ne 0 ]] ; then echo -e "\n[${SCRIPT_Name}]:\tConcatenation failed with exit code \"${SEQL_status[0]}\"!\n"               ; exit 7 ; fi
if [[ "${SEQL_status[1]}" -ne 0 ]] ; then echo -e "\n[${SCRIPT_Name}]:\tSorting failed with exit code \"${SEQL_status[1]}\"!\n"                     ; exit 8 ; fi
if [[ "${SEQL_status[2]}" -ne 0 ]] ; then echo -e "\n[${SCRIPT_Name}]:\t'SEQUEL_preprocess.awk' terminated with exit code \"${SEQL_status[2]}\"!\n" ; exit 9 ; fi


#- Remove the extracted data (not needed anymore once preprocessing is complete)
rm "${SPIPE_ext}/EXT.${SPIPE_smrtc}.sc.txt"
rm "${SPIPE_ext}/EXT.${SPIPE_smrtc}.sr.txt"
#-

rm "${SEQL_block}"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
